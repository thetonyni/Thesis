---
output:
  pdf_document: default
  html_document: default
---
# Case Study {#casestudy}

<!--
Each chapter file must start with a chapter header (e.g., # Chapter name). Notice we have also included a label after the chapter name ({# intro}) so we can refer back to this chapter later in the text if want to (e.g., by using \@ref(intro)). This also helps you debut potential issues as you knit.

You can knit chapters all at once using the index file, or individually. When you knit a single chapter, every other chapter will have a one-sentence placeholder to make knitting easier.

You can re-name each chapter file (e.g., change this filename from "01-chap1.Rmd" to "01-introduction.Rmd"), just make sure you also update the filename in the list of rmd files in _bookdown.yml.

The introduction should provide an overview of the work you set out to do and provide structure for the remainder of the document.

-->

```{r, warning = FALSE, echo = FALSE}
library(tidyverse)
library(kableExtra)
library(mosaic)
library(usmap)
```


## Background {#background}

Coal is one of the most prevalent combustible fuels being burned all across the world, as it is one of the easiest methods of obtaining energy due to the abundance of the substance. Generally, coal plants produce electricity by burning coal, which produces coal ash as a byproduct. Over 100 million tons of coal ash are produced every year at these plants, which are then disposed through landfills and waste ponds at these plants. The main concern of ecologists regarding this matter is that the coal ash produced by these plants can often contaminate the local groundwater, leading to toxic contaminants being found in local water sources. Coal ash is dangerous due to its composition, which contains a long list of dangerous chemicals including -- but not limited to: arsenic, radium, boron, and a large list of other contaminants toxic to humans and animals alike [@Kelderman2019]. 

Complaints and concerns regarding the disposing practices of coal plants have only increased after the 2010 Kingston Fossil Plant coal ash incident in Tennessee. This area has become an attractive location in which many sites of ecological studies have been conducted the years following the incident. Leaching experiments conducted by @Ruhl2010 has revealed significant levels of dissolved Arsenic, Boron, Strontium, and Barium in the water which has been in contact with the coal ash, which they note to be threat to infaunal species in the water. Prompted by environmental organizations, groups, and individuals alike, an onslaught of pressure was put on the Environmental Protection Agency, which resulted in the Coal Ash Rule being put into effect in 2015 [@Kelderman2019].

This rule has forced over 265 coal power plants -- about 3/4 of all coal power plants in the US - to make data regarding chemical concentrations publicly available to the general population. In their analysis using this data, the @EIP2020 -- a non-profit organization dedicated to issues involving environmental justice, has discussed the prevalence of groundwater contamination for wells located near coal related facilities. 

<!-- insert picture here -->

```{r, echo = FALSE, upgradientdowngradient, fig.cap="Difference Between Upgradient and Downgradient Wells", out.width = '100%'}
knitr::include_graphics(path = "figures/upgradientdowngradient.jpg")
```

Typically in a coal ash plant, there exists two types of wells: upgradient wells and downgradient wells. These wells are essential to measure the amount of contamination being caused by coal ash. Upgradient wells, also known as background wells, measures the concentrations of chemicals in groundwater before it passes through an coal ash dump. Conversely, downgradient wells measure the concentrations of chemicals in groundwater after it passes through a coal ash dump.

<!--With this information, typically -- one estimates the amount of chemical contamination caused by a coal as dump by subtracting the upgradient concentration from the downgradient concentration of a chemical (downgradient concentration - upgradient concentration). -->

While both types of well are susceptible to contamination through coal ash related means, it is more frequently the case that we focus on the downgradient wells, as they are more closely linked to the water accessed by the general public.

The goal of the study conducted by @Kelderman2019 was to identify the percentage of coal plants which have unsafe levels of contamination. Determining whether if a well was contaminated or not was largely influenced by the average mean concentrations of the contaminant in question for that well. If the average mean contamination of a contaminant, say, arsenic, was above the health-based threshold considered necessary to ensure safety, then that well would be marked as an "exceedance," and deemed to be contaminated.  

@Kelderman2019 notes the possibility of contamination being caused by an external factor, unrelated to the coal ash, and provides a stipulation as how to account for this. They excluded tallying the wells in which the mean downgradient values were lower than the mean upgradient values, as this would mean that the contamination was not caused by the coal plant itself.

## Data {#data}
<!-- 
WHERE THE DATA CAME FROM
whichever website (talk about environmental integrity project) and what they did to get this data (use xlsx for this)
this data was publcicaly available, but EIP collated it someway to make it public
the data is NOT just a single of coalset, give examples of contaminants that it’s taking measurements on
many sites within sites
-->

It is important to note where the data used originated from, before we delve into the details of our case study. As such, a brief history regarding the Coal Ash Rule and its origin will be explored, alongside details regarding our coal ash dataset.

### Coal Ash Rule {#coalashrule}

<!-- EXPLAIN COAL ASH RULE HERE AND HOW THE EIP (Environmental Integrity Project) HAS HELPED MAKE THIS RULE -->

A large coal ash spill at the Tennessee Valley Authority (TVA) which occurred on December 22, 2008 in Kingston, TN -- prompted the Environmental Protection Agency (EPA) to propose a set of standardized regulations and procedures to address the concerns regarding coal ash plants nationwide in the US. This was known as the Coal Ash Rule, which passed legislation on December 19, 2014 [@Car2020].

Changes were made to the Coal Ash Rule over the years in the form of 'amendments,' in which the most relevant to this study, required coal facilities to publish information and data regarding the concentrations of contaminants in the wells.

### Source of Data

The data used in the study are from the results published in "Annual Groundwater Monitoring and Corrective Action Reports," which were made available to the public in March 2018 as a result of the Coal Ash Rule. These reports are in PDF format and are thousands of pages long, which makes it difficult for individuals to parse through data in a meaningful way.

The @EIP2020 obtained the data from an online, publicly available database containing groundwater monitoring results from the first "Annual Groundwater Monitoring and Corrective Action Reports" in 2018 which was collected from coal plants and coal ash dumps under the Coal Ash Rule.

They wrangled the data into a more accessible machine-readable format which contains information from over 443 annual groundwater monitoring reports posted by 265 coal ash plants, downloadable from the EIP's website, which we use in our case study.

\newpage

### Variables {#variables}
<!-- TALK ABOUT VARIABLES AND WELLS/SITES HERE AND WHAT THEY MEAN -->

The coal dataset contains information regarding chemical concentrations at coal plants. A coal plant consists of multiple disposal areas for the coal ash that it produces. At each disposal area, there are specific locations that groundwater is being measured, known as wells, which represent an observation in the dataset. There are over 265 coal plants, also known as "sites," in this dataset. A single site is divided into multiple subsections, known as "disposal areas." Each well can be associated with a disposal area and subsequently, a site.

Specifics regarding the variables in the coal dataset can be viewed in Table 3.1. Each observation in the dataset represents a well which measures the concentration of the contaminant in question. Most of the variables are explanatory, such as the state, site, and disposal area in which the well is located in. However, there are several variables specific to groundwater data collection which are important to note.

There are four different types that each well can be classified as, which is represented in the `type` variable. These consist of: `L`, `M`, `SI`, and `U` which stand for "landfill," "mixed," "surface-impacted," and "unknown." We have already mentioned downgradient and upgradient wells during our discussion of the coal ash rule, but we will provide more detail now. In a groundwater monitoring system it is common to have designated wells for specific purposes. A common approach in a coal site is to have separate wells, upgradient wells, whose purpose is to measure "natural" water conditions and downgradient wells, which measures water conditions after it passes through a coal ash disposal area.

Coal plants may also follow different reporting protocols, which neccisitates the our "measurement unit," column. While some contaminants such as radium, are measured only in one unit (pCi/L) -- most others are measured differently across sites. One sits may measure arsenic with using milligrams/L while another site uses micrograms/L. 

The remaining variables in our dataset are mostly self explanatory, containing information regarding the date when sample was collected, unique ID of the well, and whether if the measurement is below the limit of detection.

<!-- TABLE OF DATA DICTIONARY TO INSERT HERE -->

```{r, echo = FALSE}
dd_var <- c("State", "Site", "Disposal Area", "Type of Well",
            "ID of Well", "Gradient Type", 
            "Sample Date", 
            "Contaminant Name", "Measurement Unit",
            "Below Detection", "Concentration")

dd_varname<- c("state", "site", "disposal.area", "type", "well.id",
             "gradient", "samp.date", "contaminant",
             "measurement.unit", "below.detection",
             "concentration")

dd_desc <- c("The state where the site is located.",
             "The name of the site as it is presented in its
             groundwater monitoring report.",
             "The name of the disposal area(s) as they are presented 
             in the groundwater monitoring report. Note: some wells 
             monitor groundwater from more than one disposal unit.",
             "The type of disposal unit. SI = surface impoundment, 
             L= landfill, M = mixed multi-unit (landfill and surface 
             impoundment), and U = unknown.",
             "The identifier given to each monitoring well in the 
             groundwater monitoring report.",
             "The location of the groundwater monitoring well 
             relative to the regulated ash disposal unit it 
             monitors.",
             "The date the well was sampled.",
             "The contaminant name. These have been standardized to 
             allow for analyses across plants.",
             "The concentration units. These include mg/l, ug/l, 
             pCi/l, and standard units (SU) for pH.",
             "LOD status for the concentration, '<' indicates that 
             the concentration was below the LOD.",
             "The concentration of the contaminant.")

dd <- as.data.frame(cbind(dd_var, dd_varname, dd_desc)) %>%
  rename("Variable" = "dd_var",
         "Variable Name" = "dd_varname",
         "Description" = "dd_desc") 

```

```{r, echo = FALSE}
knitr::kable(dd, caption = "Data dictionary for the coal dataset.",
             booktabs = "T", linesep = "\\addlinespace") %>%
             column_spec(3, width = "7.6cm")
```

### Plan of Action

The investigation conducted by @Kelderman2019 mentions certain restrictions within the data that we believe may have caused their analysis to potentially be inaccurate. The limit of detection problem arises when measuring devices used to measure chemical concentrations are unable to detect below a certain threshold, causing large numbers of observations to be considered "below detection." These values are often encoded as NA or even mistakenly marked as 0. 

Our end goal remains the same as the @Kelderman2019: to identify contaminated groundwater in coal plants. @Kelderman2019 handled these censored values by assuming that their concentration was one half of the detection limit. In essence, they employed the substitution method in in order to obtain calculations of the average concentrations of the downgradient and upgradient wells. From our previous discussion on sentiment regarding the substitution method and from our simulation study, we observe that the substitution method may not be the best way to handle left-censored data in most, if not all, of our settings.

The goal of our case study is to employ the techniques we introduced back in chapter 2 to see if they would result in potential differently conclusions. Specifically, we wish to check if the proportion of wells in the U.S. in which contamination is present would be altered if we used our techniques to calculate the average concentrations of the contaminants. Rather than utilizing the substitution method as @Kelderman2019 has done, we are interested to employ the MLE, KM, and ROS methods in handling for left-censored cases.

Our investigation works with methods on handling this missing data through the techniques detailed in chapter 1 in order to obtain more accurate and precise estimates of the mean concentrations of contaminants at coal ash sites. Through our newly obtained estimates, we hope to see if they might lead us to different beliefs than the claims made by @Kelderman2019 regarding the the top 10 most contaminated wells in the U.S.

## Application

```{r, echo = FALSE}
#importing in full dataset
import_df <- read_csv("code/current/data/chemical_data.csv", col_types = cols())
```

```{r prelim, echo = FALSE, message = FALSE, cache = TRUE}
#breaking apart into different datasets for each region
northeast <- import_df %>%
  filter(state %in% c("ME", "NH", "VT", "NY", "PA", "NJ", "MD", 
                      "MA", "DE", "RI", "CT")) %>%
  mutate(region = "northeast")

midwest <- import_df %>%
  filter(state %in% c("OH", "IN", "MI", "IL", "WI", "MN", "IA", 
                      "MO", "ND", "SD", "NE", "KS"))%>%
  mutate(region = "midwest")

west <- import_df %>%
  filter(state %in% c("WA", "MT", "OR", "ID", "WY", "CA", "NV", 
                      "UT", "CO", "AZ", "NM", "AK", "HI")) %>%
  mutate(region = "west")

south <- import_df %>%
  filter(state %in% c("WV", "VA", "KY", "TN", "NC", "SC", "GA", 
                      "FL", "MS", "AL", "LA", "AR", "OK", "TX", "PR")) %>%
  mutate(region = "south")

#rejoin them back together for future ref. if needed
full <- list(northeast, midwest, west, south) %>% 
  reduce(full_join) %>%
  select(-c("qualifier", "link"))

#getting # of sites in each state

midwest_n <- midwest %>%
  group_by(state) %>%
  distinct(site) %>%
  summarize(n = n())

northeast_n <- northeast %>%
  group_by(state) %>%
  distinct(site) %>%
  summarize(n = n())

south_n <- south %>%
  group_by(state) %>%
  distinct(site) %>%
  summarize(n = n())

west_n <- west %>%
  group_by(state) %>%
  distinct(site) %>%
  summarize(n = n())

states_n <- rbind(midwest_n, northeast_n, south_n, west_n)

state_name <- state.name
state_abb <- state.abb
states_map <- map_data("state")
```

### Background (tentative title)

As we can see from figure 3.2, out of the 265 sites in our dataset, most of them are concentrated heavily in the mid-western and southern areas of the United States. The report written by @Kelderman2019 pointed out that 91% of these sites (242 sites, to be precise) had groundwater wells with contaminants at an unsafe level determined by the health-based threshold put out by the EPA.

```{r, usmap, echo = FALSE, message = FALSE, fig.cap="Counts of Coal Sites in the United States"}
plot_usmap(data = states_n, values = "n", regions = "states") +
  scale_fill_continuous(low = "white", high = "red", 
                        name = "Well Counts (2018)", 
                        label = scales::comma) + 
  theme(legend.position = "right", 
        panel.background = element_rect(color = "white", 
                                        fill = "white"),
        plot.background = element_rect(color = "white"))
```

### Kelderman's Top 10 Sites

As stated previously, @Kelderman2019 compiled a list of the top ten most contaminated sites across the U.S., following the EPA's health-based threshold for specific contaminants. We will briefly follow with a discussion on their methodology in determining these top ten most contaminated sites.

First, they calculated the average mean concentration for all contaminants in each well across all dates. To ensure that all observations used in this calculation were attributable to the coal site in question, there are several guidelines that were followed.

After these values are obtained, any wells with average downgradient concentrations lower than the highest average upgradient concentration for that specific contaminant and disposal area were removed. It is also important to note that since upgradient wells measure the quality of the water _before_ it passes through a coal site, they are also removed.

These two exclusion principles are followed to ensure that we did not use any wells that potentially had contamination from an external source, apart from the coal site. The remaining average mean concentrations of the contaminants in question for each site are then compared to the health-based thresholds set by the EPA, these thresholds can be viewed in Table 3.2.

```{r echo = FALSE}
#CODE TO MAKE HEALTH BASED THRESHOLDS TABLE

hbt_names <- c("Antimony", "Arsenic", "Barium", "Beryllium",
               "Boron", "Cadmium", "Chromium", "Cobalt", "Fluoride",
               "Lead", "Lithium", "Mercury", "Molybdenum",
               "Radium", "Selenium", "Sulfate", "Thallium")

hbt_values <- c(6, 10, 2, 4, 
                3, 5, 100, 6, 4,
                15, 40, 2, 40, 
                5, 50, 500, 2)

hbt_units <- c("ug/L", "ug/L", "mg/L", "ug/L", 
               "mg/L", "ug/L", "ug/L", "ug/L", "mg/L",
               "ug/L", "ug/L", "ug/L","ug/L", 
               "pCi/L", "ug/L", "mg/L", "ug/L")

hbt <- as.data.frame(cbind(hbt_names, hbt_values, hbt_units)) %>%
  rename("Contaminant" = "hbt_names",
         "Exceedance Limit" = "hbt_values",
         "Unit" = "hbt_units") 
```

```{r, echo = FALSE}
knitr::kable(hbt, caption = "Health-based thresholds set by EPA.",
             booktabs = "T", linesep = "\\addlinespace")
```

For each site, the wells with the highest average concentration of each contaminant were identified and compared to their respective health-based thresholds. A ratio is then calculated for each of these highest average contaminants to the health-based thresholds. These contaminant-specific ratios are then summed together in order to get a cumulative "contamination score" for each site. Contamination scores of a higher magnitude indicates more "severe" contamination, with the top ten highest contamination scores comprising the top ten most contaminated sites.

While the contamination scores are not explicitly published in @Kelderman2019's report, the site names of the top ten most contaminated sites in the country according to their analysis which in descending order severity are as follows:

      1. San Miguel Plant,
      2. Allen Steam Station
      3. Jim Bridger Power Plant
      4. Naughton Power Plant
      5. New Castle Generating Station
      6. Allen Fossil Plant
      7. Brandywine Ash Management Facility
      8. Hunter Power Plant
      9. R.D. Morrow, Sr. Generating Station
      10. Ghent Generating Station

We will follow their criterion(s) for determining if a well is contaminated, with the only difference being how we obtain the average concentrations of the contaminants in the wells. We will use our several left-censored estimation techniques to obtain mean estimates of the concentrations while accounting for the values below the limit of detection and see if our results significantly differ from the top ten list of most contaminated sites obtained by @Kelderman2019. We will also have a baseline implementation of the methods described by @Kelderman2019, without any attempts to account for the censored data. This implementation will serve as our control in which we will compare our left-censored estimation techniques towards.

### (Our) Top Ten Most Contaminated Sites

```{r, echo = FALSE, message = FALSE, warning = FALSE}
#we need to standardize values, some wells report concentration of contaminants in different units, we will standardize all units to the units provided by the health-based threshold set by the EPA

#template to find different units
template <- full %>%
  filter(grepl("Antimony", contaminant)) %>% #select all rows containing __
  group_by(measurement.unit) %>%
  summarize(n = n())

#antimony has units mg/L and ug/L, we need to change all to ug/L
antimony <- full %>%
  filter(grepl("Antimony", contaminant)) %>%
  mutate(concentration = 
           case_when(
             measurement.unit %in% "mg/l" ~ concentration*1000,
             measurement.unit %in% "ug/l" ~ concentration),
         measurement.unit = "ug/l")
  
#arsenic has units mg/L and ug/L, we need to change all to ug/L
arsenic <- full %>%
  filter(grepl("Arsenic", contaminant)) %>%
  mutate(concentration = 
           case_when(
             measurement.unit %in% "mg/l" ~ concentration*1000,
             measurement.unit %in% "ug/l" ~ concentration),
         measurement.unit = "ug/l")

#barium has units  mg/l and ug/l, we need to change all to mg
barium <- full %>%
  filter(grepl("Barium", contaminant)) %>%
  mutate(concentration = 
           case_when(
             measurement.unit %in% "mg/l" ~ concentration,
             measurement.unit %in% "ug/l" ~ concentration/1000),
         measurement.unit = "mg/l")

#beryllium has units mg/l and ug/l, we need to change all to ug
beryllium <- full %>%
  filter(grepl("Beryllium", contaminant)) %>%
  mutate(concentration = 
           case_when(
             measurement.unit %in% "mg/l" ~ concentration*1000,
             measurement.unit %in% "ug/l" ~ concentration),
         measurement.unit = "ug/l")

#boron has units mg/l and ug/l, we need to change all to mg
boron <- full %>%
  filter(grepl("Boron", contaminant)) %>%
  mutate(concentration = 
           case_when(
             measurement.unit %in% "mg/l" ~ concentration,
             measurement.unit %in% "ug/l" ~ concentration/1000),
         measurement.unit = "mg/l")

#cadmium has units mg/l and ug/l, we need to change all to ug
cadmium <- full %>%
  filter(grepl("Cadmium", contaminant)) %>%
  mutate(concentration = 
           case_when(
             measurement.unit %in% "mg/l" ~ concentration*1000,
             measurement.unit %in% "ug/l" ~ concentration),
         measurement.unit = "ug/l")

#chromium has units mg/l and ug/l, we need to change all to ug
chromium <- full %>%
  filter(grepl("Chromium", contaminant)) %>%
  mutate(concentration = 
           case_when(
             measurement.unit %in% "mg/l" ~ concentration*1000,
             measurement.unit %in% "ug/l" ~ concentration),
         measurement.unit = "ug/l")

#cobalt has units mg/l and ug/l, we need to change all to ug
cobalt <- full %>%
  filter(grepl("Cobalt", contaminant)) %>%
  mutate(concentration = 
           case_when(
             measurement.unit %in% "mg/l" ~ concentration*1000,
             measurement.unit %in% "ug/l" ~ concentration),
         measurement.unit = "ug/l")

#fluoride has units mg/l and mg/l, we need to change all to mg
fluoride <- full %>%
  filter(grepl("Fluoride", contaminant)) %>%
  mutate(concentration = 
           case_when(
             measurement.unit %in% "mg/l" ~ concentration,
             measurement.unit %in% "ug/l" ~ concentration/1000),
         measurement.unit = "mg/l")

#lead has units mg/l and ug/l, we need to change all to ug
lead <- full %>%
  filter(grepl("Lead", contaminant)) %>%
  mutate(concentration = 
           case_when(
             measurement.unit %in% "mg/l" ~ concentration*1000,
             measurement.unit %in% "ug/l" ~ concentration),
         measurement.unit = "ug/l")

#lithium has units mg/l and ug/l, we need to change all to ug
lithium <- full %>%
  filter(grepl("Lithium", contaminant)) %>%
  mutate(concentration = 
           case_when(
             measurement.unit %in% "mg/l" ~ concentration*1000,
             measurement.unit %in% "ug/l" ~ concentration),
         measurement.unit = "ug/l")


#mercury has units mg/l and ug/l, we need to change all to ug
mercury <- full %>%
  filter(grepl("Mercury", contaminant)) %>%
  mutate(concentration = 
           case_when(
             measurement.unit %in% "mg/l" ~ concentration*1000,
             measurement.unit %in% "ug/l" ~ concentration),
         measurement.unit = "ug/l")


#molybdenum has units mg/l and ug/l, we need to change all to ug
molybdenum <- full %>%
  filter(grepl("Molybdenum", contaminant)) %>%
  mutate(concentration = 
           case_when(
             measurement.unit %in% "mg/l" ~ concentration*1000,
             measurement.unit %in% "ug/l" ~ concentration),
         measurement.unit = "ug/l")


#radium has units mg/l (14), pCi/l (30k+), ug/l (1), we need to change all to pCi
radium <- full %>%
  filter(grepl("Radium", contaminant)) %>%
  filter(measurement.unit %in% "pCi/l")

#selenium has units mg/l (23k+), pCi/l (8), ug/l (14k+), we need to change all to ug
selenium <- full %>%
  filter(grepl("Radium", contaminant)) %>%
  filter(measurement.unit %in% c("mg/l, ug/l")) %>%
  mutate(concentration = 
           case_when(
             measurement.unit %in% "mg/l" ~ concentration*1000,
             measurement.unit %in% "ug/l" ~ concentration),
         measurement.unit = "ug/l")  

#sulfate has units mg/l and ug/l, we need to change all to mg
sulfate <- full %>%
  filter(grepl("Sulfate", contaminant)) %>%
  mutate(concentration = 
           case_when(
             measurement.unit %in% "mg/l" ~ concentration,
             measurement.unit %in% "ug/l" ~ concentration/1000),
         measurement.unit = "mg/l")

#thallium has units mg/l (23k+), pCi/l (16), ug/l (13k+), we need to change all to ug
thallium <- full %>%
  filter(grepl("Thallium", contaminant)) %>%
  filter(measurement.unit %in% c("mg/l, ug/l")) %>%
  mutate(concentration = 
           case_when(
             measurement.unit %in% "mg/l" ~ concentration*1000,
             measurement.unit %in% "ug/l" ~ concentration),
         measurement.unit = "ug/l")  

#recombine back into new standardized df
df_std <- rbind(antimony, arsenic, barium, beryllium, boron, cadmium,
                chromium, cobalt, fluoride, lead, lithium, mercury, 
                molybdenum, radium, selenium, sulfate, thallium)
```

```{r, echo = FALSE, message = FALSE, warning = FALSE}
#calculation of avg mean concentration for all contaminants in each well across all dates

#get average mean conc for all contaminants in each well
avg_control <- df_std %>%
  group_by(well.id, contaminant, measurement.unit, gradient, site) %>%
  summarize(avg_conc = mean(concentration)) %>%
  ungroup()

#get highest avg. upgradient concentrations for each contaminant/site
upgrad_control <- avg_control %>%
  filter(gradient %in% "Upgradient") %>%
  group_by(contaminant, site) %>%
  summarize(upgrad_conc = min(avg_conc)) %>%
  ungroup()

#remove upgradient wells
downgrad_control <- avg_control %>%
  filter(gradient %in% "Downgradient") %>%
  select(c(well.id, contaminant, site, avg_conc))

#remove any wells with average downgradient concentrations lower than the highest average upgradient concentration for that specific contaminant/site

downgrad_control2 <- left_join(downgrad_control, upgrad_control) %>%
  filter(avg_conc > upgrad_conc) #remove downgradient mean concentrations that were greater than “background” levels


#for each site, identify the well(s) with the highest mean concentration of each contaminant
highest_control <- downgrad_control2 %>%
  group_by(site, contaminant) %>%
  slice(which.max(avg_conc)) %>%
  mutate(contaminant = recode(contaminant,
                              "Antimony, total" = "Antimony",
                              "Arsenic, total" = "Arsenic",
                              "Barium, total" = "Barium",
                              "Beryllium, total" = "Beryllium",
                              "Boron, total" = "Boron",
                              "Cadmium, total" = "Cadmium",
                              "Chromium, total" = "Chromium",
                              "Cobalt, total" = "Cobalt",
                              "Fluoride, total" = "Fluoride",
                              "Lead, total" = "Lead",
                              "Lithium, total" = "Lithium",
                              "Mercury, total" = "Mercury",
                              "Molybdenum, total" = "Molybdenum",
                              "Radium 226+228" = "Radium",
                              "Selenium, total" = "Selenium",
                              "Thallium, total" = "Thallium"))

hbt_case <- hbt %>% #case sensitivity
  rename("contaminant" = "Contaminant",
         "limit" = "Exceedance Limit",
         "unit" = "Unit") 
  
top10_control <- left_join(highest_control, hbt_case, by = "contaminant") %>%
  mutate(ratio = avg_conc/as.numeric(limit)) %>% #calculate the ratios -> ‘highest average’ concentrations/hbt
  group_by(site) %>%
  summarize(composite_score = sum(ratio)) %>% #sum together all contaminants for a site to get a composite score
  arrange(desc(composite_score)) %>%
  slice(1:10)
```

```{r, echo = FALSE, message = FALSE, warning = FALSE, cache = TRUE}
#calculation of avg mean concentration for all contaminants in each well across all dates

#get average mean conc for all contaminants in each well
avg_substitution <- df_std %>%
  mutate(concentration_new = if_else(below.detection %in% "<", 
                                     concentration/2, concentration))%>%
  group_by(well.id, contaminant, measurement.unit, gradient, site) %>%
  summarize(avg_conc = mean(concentration_new)) %>%
  ungroup()

#get highest avg. upgradient concentrations for each contaminant/site
upgrad_substitution <- avg_substitution %>%
  filter(gradient %in% "Upgradient") %>%
  group_by(contaminant, site) %>%
  summarize(upgrad_conc = min(avg_conc)) %>%
  ungroup()

#remove upgradient wells
downgrad_substitution <- avg_substitution %>%
  filter(gradient %in% "Downgradient") %>%
  select(c(well.id, contaminant, site, avg_conc))

#remove any wells with average downgradient concentrations lower than the highest average upgradient concentration for that specific contaminant/site
downgrad_substitution2 <- left_join(downgrad_substitution, upgrad_substitution) %>%
  filter(avg_conc >= upgrad_conc) #remove downgradient mean concentrations that were lower than “background” levels


#for each site, identify the well(s) with the highest mean concentration of each contaminant
highest_substitution <- downgrad_substitution2 %>%
  group_by(site, contaminant) %>%
  slice(which.max(avg_conc)) %>%
  mutate(contaminant = recode(contaminant,
                              "Antimony, total" = "Antimony",
                              "Arsenic, total" = "Arsenic",
                              "Barium, total" = "Barium",
                              "Beryllium, total" = "Beryllium",
                              "Boron, total" = "Boron",
                              "Cadmium, total" = "Cadmium",
                              "Chromium, total" = "Chromium",
                              "Cobalt, total" = "Cobalt",
                              "Fluoride, total" = "Fluoride",
                              "Lead, total" = "Lead",
                              "Lithium, total" = "Lithium",
                              "Mercury, total" = "Mercury",
                              "Molybdenum, total" = "Molybdenum",
                              "Radium 226+228" = "Radium",
                              "Selenium, total" = "Selenium",
                              "Thallium, total" = "Thallium"))

top10_substitution <- left_join(highest_substitution, hbt_case, by = "contaminant") %>%
  mutate(ratio = avg_conc/as.numeric(limit)) %>% #calculate the ratios -> ‘highest average’ concentrations/hbt
  group_by(site) %>%
  summarize(composite_score = sum(ratio)) %>% #sum together all contaminants for a site to get a composite score
  arrange(desc(composite_score)) %>%
  slice(1:10)
```

```{r, echo = FALSE, message = FALSE, warning = FALSE, eval = FALSE}

get_mle_mean <- function(values, censored){
  mle = cenmle(values, censored)
  return(mean(mle)[1])
}

#calculation of avg mean concentration for all contaminants in each well across all dates

#get average mean conc for all contaminants in each well
avg_mle <- df_std %>%
  mutate(censored = if_else(below.detection %in% "<", 
                                     TRUE, FALSE)) %>%
  filter(concentration > 0)

avg_mle2 <- avg_mle %>%
  group_by(well.id, contaminant, measurement.unit, gradient, site) %>%
  do(summarize(., avg_conc = get_mle_mean(.$concentration, .$censored))) %>%
  ungroup()

#get highest avg. upgradient concentrations for each contaminant/site
upgrad_mle <- avg_mle2 %>%
  filter(gradient %in% "Upgradient") %>%
  group_by(contaminant, site) %>%
  summarize(upgrad_conc = min(avg_conc)) %>%
  ungroup()

#remove upgradient wells
downgrad_mle <- avg_mle2 %>%
  filter(gradient %in% "Downgradient") %>%
  select(c(well.id, contaminant, site, avg_conc))

#remove any wells with average downgradient concentrations lower than the highest average upgradient concentration for that specific contaminant/site
downgrad_mle2 <- left_join(downgrad_mle, upgrad_mle) %>%
  filter(avg_conc >= upgrad_conc) #remove downgradient mean concentrations that were lower than “background” levels


#for each site, identify the well(s) with the highest mean concentration of each contaminant
highest_mle <- downgrad_mle2 %>%
  group_by(site, contaminant) %>%
  slice(which.max(avg_conc)) %>%
  mutate(contaminant = recode(contaminant,
                              "Antimony, total" = "Antimony",
                              "Arsenic, total" = "Arsenic",
                              "Barium, total" = "Barium",
                              "Beryllium, total" = "Beryllium",
                              "Boron, total" = "Boron",
                              "Cadmium, total" = "Cadmium",
                              "Chromium, total" = "Chromium",
                              "Cobalt, total" = "Cobalt",
                              "Fluoride, total" = "Fluoride",
                              "Lead, total" = "Lead",
                              "Lithium, total" = "Lithium",
                              "Mercury, total" = "Mercury",
                              "Molybdenum, total" = "Molybdenum",
                              "Radium 226+228" = "Radium",
                              "Selenium, total" = "Selenium",
                              "Thallium, total" = "Thallium"))

top10_mle <- left_join(highest_mle, hbt_case, by = "contaminant") %>%
  mutate(ratio = avg_conc/as.numeric(limit)) %>% #calculate the ratios -> ‘highest average’ concentrations/hbt
  group_by(site) %>%
  summarize(composite_score = sum(ratio)) %>% #sum together all contaminants for a site to get a composite score
  arrange(desc(composite_score)) %>%
  slice(1:10)
```

```{r, echo = FALSE, message = FALSE, warning = FALSE, cache = TRUE}
get_km_mean <- function(values, censored){
  km = cenfit(values, censored)
  mean(km)[[1]]
}

#calculation of avg mean concentration for all contaminants in each well across all dates

#get average mean conc for all contaminants in each well
avg_km <- df_std %>%
  mutate(censored = if_else(below.detection %in% "<", 
                                     TRUE, FALSE)) %>%
  group_by(well.id, contaminant, measurement.unit, gradient, site) %>%
  do(summarize(., avg_conc = get_km_mean(.$concentration, .$censored))) %>%
  ungroup()

#get highest avg. upgradient concentrations for each contaminant/site
upgrad_km <- avg_km %>%
  filter(gradient %in% "Upgradient") %>%
  group_by(contaminant, site) %>%
  summarize(upgrad_conc = min(avg_conc)) %>%
  ungroup()

#remove upgradient wells
downgrad_km <- avg_km %>%
  filter(gradient %in% "Downgradient") %>%
  select(c(well.id, contaminant, site, avg_conc))

#remove any wells with average downgradient concentrations lower than the highest average upgradient concentration for that specific contaminant/site
downgrad_km2 <- left_join(downgrad_km, upgrad_km) %>%
  filter(avg_conc >= upgrad_conc) #remove downgradient mean concentrations that were lower than “background” levels


#for each site, identify the well(s) with the highest mean concentration of each contaminant
highest_km <- downgrad_km2 %>%
  group_by(site, contaminant) %>%
  slice(which.max(avg_conc)) %>%
  mutate(contaminant = recode(contaminant,
                              "Antimony, total" = "Antimony",
                              "Arsenic, total" = "Arsenic",
                              "Barium, total" = "Barium",
                              "Beryllium, total" = "Beryllium",
                              "Boron, total" = "Boron",
                              "Cadmium, total" = "Cadmium",
                              "Chromium, total" = "Chromium",
                              "Cobalt, total" = "Cobalt",
                              "Fluoride, total" = "Fluoride",
                              "Lead, total" = "Lead",
                              "Lithium, total" = "Lithium",
                              "Mercury, total" = "Mercury",
                              "Molybdenum, total" = "Molybdenum",
                              "Radium 226+228" = "Radium",
                              "Selenium, total" = "Selenium",
                              "Thallium, total" = "Thallium"))

top10_km <- left_join(highest_km, hbt_case, by = "contaminant") %>%
  mutate(ratio = avg_conc/as.numeric(limit)) %>% #calculate the ratios -> ‘highest average’ concentrations/hbt
  group_by(site) %>%
  summarize(composite_score = sum(ratio)) %>% #sum together all contaminants for a site to get a composite score
  arrange(desc(composite_score)) %>%
  slice(1:10)
```

```{r, eval = FALSE, echo = FALSE, message = FALSE, warning = FALSE}
get_ros_mean <- function(values, censored){
  ros_res = ros(values, censored)
  NADA::mean(ros_res)
}

#calculation of avg mean concentration for all contaminants in each well across all dates

#get average mean conc for all contaminants in each well
avg_ros <- df_std %>%
  mutate(censored = if_else(below.detection %in% "<", 
                                     TRUE, FALSE)) %>%
  group_by(well.id, contaminant, measurement.unit, gradient, site) %>%
  do(summarize(., avg_conc = get_ros_mean(.$concentration, .$censored))) %>%
  ungroup()


obs      = c(0.5,    0.5,   1.0,  1.5,   5.0,    10,   100)
censored = c(TRUE, FALSE, FALSE, TRUE, FALSE, FALSE, FALSE)
groups   = c("A", "A", "A", "B", "B", "B", "B")

test <- cbind.data.frame(obs, censored, groups) %>%
  group_by(groups) %>%
  do(summarize(., avg_conc = get_ros_mean(.$obs, .$censored))) %>%
  ungroup()

#get average mean conc for all contaminants in each well
avg_control <- df_std %>%
  group_by(well.id, contaminant, measurement.unit, gradient, site) %>%
  summarize(avg_conc = mean(concentration)) %>%
  ungroup()

#get highest avg. upgradient concentrations for each contaminant/site
upgrad_ros <- avg_ros %>%
  filter(gradient %in% "Upgradient") %>%
  group_by(contaminant, site) %>%
  summarize(upgrad_conc = min(avg_conc)) %>%
  ungroup()

#remove upgradient wells
downgrad_ros <- avg_ros %>%
  filter(gradient %in% "Downgradient") %>%
  select(c(well.id, contaminant, site, avg_conc))

#remove any wells with average downgradient concentrations lower than the highest average upgradient concentration for that specific contaminant/site
downgrad_ros2 <- left_join(downgrad_ros, upgrad_ros) %>%
  filter(avg_conc >= upgrad_conc) #remove downgradient mean concentrations that were lower than “background” levels


#for each site, identify the well(s) with the highest mean concentration of each contaminant
highest_ros <- downgrad_ros2 %>%
  group_by(site, contaminant) %>%
  slice(which.max(avg_conc)) %>%
  mutate(contaminant = recode(contaminant,
                              "Antimony, total" = "Antimony",
                              "Arsenic, total" = "Arsenic",
                              "Barium, total" = "Barium",
                              "Beryllium, total" = "Beryllium",
                              "Boron, total" = "Boron",
                              "Cadmium, total" = "Cadmium",
                              "Chromium, total" = "Chromium",
                              "Cobalt, total" = "Cobalt",
                              "Fluoride, total" = "Fluoride",
                              "Lead, total" = "Lead",
                              "Lithium, total" = "Lithium",
                              "Mercury, total" = "Mercury",
                              "Molybdenum, total" = "Molybdenum",
                              "Radium 226+228" = "Radium",
                              "Selenium, total" = "Selenium",
                              "Thallium, total" = "Thallium"))

top10_ros <- left_join(highest_ros, hbt_case, by = "contaminant") %>%
  mutate(ratio = avg_conc/as.numeric(limit)) %>% #calculate the ratios -> ‘highest average’ concentrations/hbt
  group_by(site) %>%
  summarize(composite_score = sum(ratio)) %>% #sum together all contaminants for a site to get a composite score
  arrange(desc(composite_score)) %>%
  slice(1:10)
```

```{r, echo = FALSE}
options(scipen=999) #prevent scientific notation

top10_control.table <- top10_control %>%
  rename("Site" = "site", 
         "Composite Score" = "composite_score")

knitr::kable(top10_control.table, caption = "Top 10 most contaminated sites 
             for our baseline (control) implementation.", 
             digits = 5, booktabs = "T", linesep = "\\addlinespace") %>%
  kable_styling(font_size = 11.5) 
```

```{r, echo = FALSE}
top10_substitution.table <- top10_substitution %>%
  rename("Site" = "site", 
         "Composite Score" = "composite_score")

knitr::kable(top10_substitution.table, caption = "Top 10 most contaminated sites 
             for our substitution method implementation.", 
             digits = 5, booktabs = "T", linesep = "\\addlinespace") %>%
  kable_styling(font_size = 11.5) 
```

```{r, echo = FALSE}
top10_km.table <- top10_km %>%
  rename("Site" = "site", 
         "Composite Score" = "composite_score")

knitr::kable(top10_km.table, caption = "Top 10 most contaminated sites 
             for our KM method implementation.", 
             digits = 5, booktabs = "T", linesep = "\\addlinespace") %>%
  kable_styling(font_size = 11.5) 
```

The results from our baseline implementation which calculates mean estimates without any attempt to account for censoring, obtains the top ten site presented in Table 3.3. When comparing this to the original substitution method using 1/2(LOD) implemented by @Kelderman2019, 9 out of the 10 sites are shared, with the only major difference being the order in which the sites are presented. As the composite scores of the sites were not originally published in @Kelderman2019's report, we are unable to delve into more of the specifics regarding the magnitude of difference between the two implementations. As such, we found it prudent to perform their analysis using the substitution method, the results of which are presented in Table 3.4. 

Something unexpected to note is that although we followed the procedures outlined by @Kelderman2019 in their implementation of the substitution method, our top ten sites presented in Table 3.5 somewhat differ from theirs. Reproducible code was not provided in their report and attempts to completely reproduce their top ten list would not be conducive to the goal of this report. As such, from now on, we will proceed with the analysis with _our_ top ten list produced by the substitution method as the norm, for the sake of comparability with our other methods.

The top ten sites obtained using th

The MLE method and the ROS method are absent from this case-study. It can be recalled that in our previous discussion regarding the MLE method, we discussed the MLE method often resulting in overinflated estimates when the data is highly skewed. Due to this limitation, using the MLE method does not provide very useful information in our study. One instance of this problem occurs where we have one well with an abnormally large concenration and hundreds of smaller wells in which the concentration is 0, the MLE method would provide concentration estimates nearing infinity, and throw the analysis into disarray, as such, using the MLE method is not beneficial in this setting.

The ROS method was absent for a similar reason, but with the limitations more-so being on the capabilities of the method itself. As we discussed previously, the ROS method can only be used in settings when more than half the data is uncensored. Unfortunately with our data, censoring far exceeds 50%, and as such, the ROS method is unable to be implemented. [PROVIDE PROOF? numbers?????]

[continue here]

Our top ten most contaminated sites when we don't use any methods to account for censoring caused us to obtain slightly different results than the top ten sites that @Kelderman2019 obtained -- specifically Sebree Generating Station is in our top ten list while Ghent Generating Station is on theirs. Also the ranking/order of our top ten sites is slightly different as well. This should not be much of a concern however, we are more focused on the methods to handle left-censoring and observing if they alter the top ten sites obtained with this baseline implementation.

Next, we will utilize the 1/2(LOD) substitution method implemented by @Kelderman2019.

Thus summarizing the results of the top ten most contaminated sites from the methods which were able to be implemented (control, substitution with 1/2(LOD), and KM), are as follows: